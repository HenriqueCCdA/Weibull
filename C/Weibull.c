#include"Weibull.h"

/**********************************************************************
 * Data de criacao    : 08/03/2020                                    *
 * Data de modificaco : 00/00/0000                                    * 
 * ------------------------------------------------------------------ *   
 * Subroutine updateA : atualizacao da matriz a com os valores x      *    
 * ------------------------------------------------------------------ * 
 * Parametros de entrada:                                             *
 * ------------------------------------------------------------------ * 
 * a - matriz 3x3 em funcao de x                                      *
 * x - valores de x                                                   *
 * ------------------------------------------------------------------ * 
 * Parametros de saida:                                               *
 * ------------------------------------------------------------------ *
 * a - matriz atualizada                                              *
 * ------------------------------------------------------------------ * 
 * OBS:                                                               *
 * ------------------------------------------------------------------ *
 *        | z*gamma(z)     0.0         0.0   |                        *  
 * A(x) = |        0.0 c^2*gamma(w)    0.0   |                        *
 *        |        0.0    -1.0         2.0   |                        *
 *                                                                    *
 *     | c |                                                          *
 * x = | w |                                                          *
 *     | z |                                                          *
 *                                                                    *
 * ------------------------------------------------------------------ * 
 **********************************************************************/
static void updateA( double *a, double *x)
{
  a[0] = x[2]*tgamma(x[2]);
  a[1] = x[0]*x[0]*tgamma(x[1]);
  a[2] =  2.e0;
  a[3] = -1.e0;
}
/**********************************************************************/

/**********************************************************************
 * Data de criacao    : 21/03/2020                                    *
 * Data de modificaco : 00/00/0000                                    * 
 * ------------------------------------------------------------------ *   
 * Subroutine solA    : modulo do residuo                             *    
 * ------------------------------------------------------------------ * 
 * Parametros de entrada:                                             *
 * ------------------------------------------------------------------ * 
 * ------------------------------------------------------------------ * 
 * Parametros de saida:                                               *
 * ------------------------------------------------------------------ *
 * ------------------------------------------------------------------ * 
 * OBS:                                                               *
 * ------------------------------------------------------------------ *
 * ------------------------------------------------------------------ * 
 **********************************************************************/
static void solvA( double *a, double *x, double *f)
{
  x[0] = f[0]/a[0];
  x[1] = f[1]/a[1];
  x[2] = -a[3]*x[1]/a[2];
}
/**********************************************************************/

/**********************************************************************
 * Data de criacao    : 21/03/2020                                    *
 * Data de modificaco : 00/00/0000                                    * 
 * ------------------------------------------------------------------ *   
 * Subroutine modRes  : modulo do residuo                             *    
 * ------------------------------------------------------------------ * 
 * Parametros de entrada:                                             *
 * ------------------------------------------------------------------ * 
 * ------------------------------------------------------------------ * 
 * Parametros de saida:                                               *
 * ------------------------------------------------------------------ *
 * ------------------------------------------------------------------ * 
 * OBS:                                                               *
 * ------------------------------------------------------------------ *
 * ------------------------------------------------------------------ * 
 **********************************************************************/
static double modRes( double *f, double *a, double *x)
{
  double r[3];
/*... R = F - Ax*/
  r[0] = f[0] - a[0]*x[0];
  r[1] = f[1] - a[1]*x[1];
  r[2] = - a[2]*x[2] - a[3]*x[1];
/*...................................................................*/

/*... |R|*/
  return sqrt( r[0]*r[0] + r[1]*r[1] + r[2]*r[2]);

}
/**********************************************************************/

/********************************************************************** 
 * Data de criacao    : 21/03/2020                                    *
 * Data de modificaco : 23/04/2020                                    * 
 * ------------------------------------------------------------------ *   
 * weibull : calculo de b e c apartir de mu e sig                     *    
 * ------------------------------------------------------------------ * 
 * Parametros de entrada:                                             *
 * ------------------------------------------------------------------ * 
 * mu    - media                                                      *
 * sig   - desvio padrão                                              *
 * b     - nao definido                                               *
 * c     - nao definido                                               *
 * tol   - tolerancia do residuo                                      *
 * maxIt - numero maximo de iteracaos                                 *
 * alf   - parametro de relaxamento                                   *
 * ------------------------------------------------------------------ * 
 * Parametros de saida:                                               *
 * ------------------------------------------------------------------ *
 * b - valor de b para mu e sig                                       *
 * c - valor de c para mu e sig                                       *
 * ------------------------------------------------------------------ * 
 * OBS:                                                               *
 * ------------------------------------------------------------------ *
 *        | z*gamma(z)     0.0         0.0   |                        *  
 * A(x) = |        0.0 c^2*gamma(w)    0.0   |                        *
 *        |        0.0    -1.0         2.0   |                        *
 *                                                                    *
 *     | c |       |     mu       |                                   *
 * x = | w |   f = | sig^2 + mu^2 |                                   *
 *     | z |       |     0.0      |                                   *
 *                                                                    *
 * ------------------------------------------------------------------ * 
 **********************************************************************/
void weibull(double const mu , double const sig
            ,double *b       , double *c
            ,double const tol, int const maxIt
            ,double const alf)
{
  short fFag;
  int i, j;
  double one, x[3], x0[3], a[4], f[2], res;

/*...*/
  fFag = 1;
/*...................................................................*/

/*... chute inicial*/
  *c = mu;
  *b = sig/mu;
  x[0] = *c;
  x[1] = 2.e0/(*b);
  x[2] = 1.e0/(*b);
/*...................................................................*/

/*...*/
  f[0] = mu;
  f[1] = sig*sig + mu*mu;
/*...................................................................*/

/*...*/
  for(i = 0; i < maxIt; i++)  {
/*...*/
    for(j = 0; j < 3; j++)
      x0[j] = x[j];
/*...................................................................*/
  
/*... atualizando a matriz a*/
    updateA(a, x);
/*...................................................................*/

/*...*/
    res = modRes(f, a, x);
    if( res < tol)  {
      fFag = 0;
      break;
    }
/*...................................................................*/

/*... x = (A^-1)*F*/
    solvA(a, x, f);
/*...................................................................*/

/*... relaxamento*/
    one = 1.e0 - alf;
    for(j = 0; j < 3; j++)
      x[j] = alf*x[j] + one*x0[j];
/*...................................................................*/
  }
/*...................................................................*/

/*...*/
  if(fFag) 
    printf("!!!Warning!!!\n");
/*...................................................................*/

/*...*/
  printf("*********************************************************\n");
  printf("Res final %e para it %d\n", res, i);
  printf("*********************************************************\n");
/*...................................................................*/

/*...*/
  *c = x[0];
  *b = 2.e0/x[1];
/*...................................................................*/

}
/*********************************************************************/

/**********************************************************************
 * Data de criacao    : 08/03/2020                                    *
 * Data de modificaco : 00/00/0000                                    * 
 * ------------------------------------------------------------------ *   
 * media : calculo da media da funcao weibull                         *    
 * ------------------------------------------------------------------ * 
 * Parametros de entrada:                                             *
 * ------------------------------------------------------------------ * 
 * b -                                                                *
 * c -                                                                *
 * ------------------------------------------------------------------ * 
 * Parametros de saida:                                               *
 * ------------------------------------------------------------------ *
 * retorna a media                                                    *
 * ------------------------------------------------------------------ * 
 * OBS:                                                               *
 * ------------------------------------------------------------------ *
 * ------------------------------------------------------------------ * 
 **********************************************************************/
double media(double b, double c)
{
  return c*tgamma(1.e0 + 1.e0/b);
}
/*********************************************************************/

/**********************************************************************
 * Data de criacao    : 08/03/2020                                    *
 * Data de modificaco : 00/00/0000                                    * 
 * ------------------------------------------------------------------ *   
 * var : calculo do variancia                                         *    
 * ------------------------------------------------------------------ * 
 * Parametros de entrada:                                             *
 * ------------------------------------------------------------------ * 
 * b -                                                                *
 * c -                                                                *
 * ------------------------------------------------------------------ * 
 * Parametros de saida:                                               *
 * ------------------------------------------------------------------ *
 * retorna do desvio padrao                                           *
 * ------------------------------------------------------------------ * 
 * OBS:                                                               *
 * ------------------------------------------------------------------ *
 * ------------------------------------------------------------------ * 
 **********************************************************************/
double var(double b, double c)
{
  double mu = media(b, c);

  return c*c*tgamma(1.e0 + 2.e0/b) - mu*mu;

}
/*********************************************************************/

/**********************************************************************
 * Data de criacao    : 08/03/2020                                    *
 * Data de modificaco : 00/00/0000                                    * 
 * ------------------------------------------------------------------ *   
 * sig : calculo do desvio padrao                                     *    
 * ------------------------------------------------------------------ * 
 * Parametros de entrada:                                             *
 * ------------------------------------------------------------------ * 
 * b -                                                                *
 * c -                                                                *
 * ------------------------------------------------------------------ * 
 * Parametros de saida:                                               *
 * ------------------------------------------------------------------ *
 * retorna do desvio padrao                                           *
 * ------------------------------------------------------------------ * 
 * OBS:                                                               *
 * ------------------------------------------------------------------ *
 * ------------------------------------------------------------------ * 
 **********************************************************************/
double std(double b, double c)
{
  return sqrt(var(b, c));
}
/*********************************************************************/